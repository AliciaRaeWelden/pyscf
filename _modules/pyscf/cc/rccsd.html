

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyscf.cc.rccsd &mdash; PySCF 1.4.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PySCF 1.4.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> PySCF
          

          
          </a>

          
            
            
              <div class="version">
                1.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">An overview of PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gto.html">gto &#8212; Molecular structure and GTO basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib.html">lib &#8212; Helper functions, parameters, and C extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scf.html">scf &#8212; Mean-field methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ao2mo.html">ao2mo &#8212; Integral transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mcscf.html">mcscf &#8212; Multi-configurational self-consistent field</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fci.html">fci &#8212; Full configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../symm.html">symm &#8211; Point group symmetry and spin symmetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../df.html">df &#8212; Density fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dft.html">dft &#8212; Density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tddft.html">tddft &#8212; Time dependent density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cc.html">cc &#8212; Coupled cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci.html">ci &#8212; Configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dmrgscf.html">dmrgscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fciqmcscf.html">fciqmcscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grad.html">grad &#8212; Analytical nuclear gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hessian.html">hessian &#8212; Analytical nuclear Hessian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pbc.html">pbc &#8212; Periodic boundary conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lo.html">lo &#8212; Orbital localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qmmm.html">qmmm &#8212; QM/MM interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mrpt.html">mrpt &#8212; Multi-reference perturbation theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark.html">Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code-rule.html">Code standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version.html">Version history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PySCF</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyscf.cc.rccsd</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyscf.cc.rccsd</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">ao2mo</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">ccsd</span>
<span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">rintermediates</span> <span class="k">as</span> <span class="n">imd</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="k">import</span> <span class="n">linalg_helper</span>

<span class="c1">#einsum = np.einsum</span>
<span class="n">einsum</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span>

<span class="c1"># This is restricted (R)CCSD</span>
<span class="c1"># Ref: Hirata et al., J. Chem. Phys. 120, 2581 (2004)</span>

<div class="viewcode-block" id="kernel"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.rccsd.kernel">[docs]</a><span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">tolnormt</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span>
           <span class="n">verbose</span><span class="o">=</span><span class="n">logger</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exactly the same as pyscf.cc.ccsd.kernel, which calls a</span>
<span class="sd">    *local* energy() function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">eris</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">cput1</span> <span class="o">=</span> <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">eold</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eccsd</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis</span><span class="p">:</span>
        <span class="n">adiis</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">diis</span><span class="o">.</span><span class="n">DIIS</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis_file</span><span class="p">)</span>
        <span class="n">adiis</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis_space</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adiis</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>

    <span class="n">conv</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_cycle</span><span class="p">):</span>
        <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">update_amps</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
        <span class="n">normt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1new</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t2new</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span>
        <span class="n">t1new</span> <span class="o">=</span> <span class="n">t2new</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis</span><span class="p">:</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">normt</span><span class="p">,</span> <span class="n">eccsd</span><span class="o">-</span><span class="n">eold</span><span class="p">,</span> <span class="n">adiis</span><span class="p">)</span>
        <span class="n">eold</span><span class="p">,</span> <span class="n">eccsd</span> <span class="o">=</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">energy</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;istep = </span><span class="si">%d</span><span class="s1">  E(CCSD) = </span><span class="si">%.15g</span><span class="s1">  dE = </span><span class="si">%.9g</span><span class="s1">  norm(t1,t2) = </span><span class="si">%.6g</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">istep</span><span class="p">,</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">eccsd</span> <span class="o">-</span> <span class="n">eold</span><span class="p">,</span> <span class="n">normt</span><span class="p">)</span>
        <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD iter&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eccsd</span><span class="o">-</span><span class="n">eold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">normt</span> <span class="o">&lt;</span> <span class="n">tolnormt</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conv</span><span class="p">,</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span></div>


<span class="c1">#def update_amps(cc, t1, t2, eris):</span>
<span class="c1">#    # Ref: Hirata et al., J. Chem. Phys. 120, 2581 (2004) Eqs.(35)-(36)</span>
<span class="c1">#    time0 = time.clock(), time.time()</span>
<span class="c1">#    log = logger.Logger(cc.stdout, cc.verbose)</span>
<span class="c1">#    nocc, nvir = t1.shape</span>
<span class="c1">#    fock = eris.fock</span>
<span class="c1">#</span>
<span class="c1">#    fov = fock[:nocc,nocc:]</span>
<span class="c1">#    foo = fock[:nocc,:nocc]</span>
<span class="c1">#    fvv = fock[nocc:,nocc:]</span>
<span class="c1">#</span>
<span class="c1">#    mo_e = eris.fock.diagonal()</span>
<span class="c1">#    eia = mo_e[:nocc,None] - mo_e[None,nocc:]</span>
<span class="c1">#    eijab = lib.direct_sum(&#39;ia,jb-&gt;ijab&#39;,eia,eia)</span>
<span class="c1">#</span>
<span class="c1">#    Foo = imd.cc_Foo(t1,t2,eris)</span>
<span class="c1">#    Fvv = imd.cc_Fvv(t1,t2,eris)</span>
<span class="c1">#    Fov = imd.cc_Fov(t1,t2,eris)</span>
<span class="c1">#    Loo = imd.Loo(t1,t2,eris)</span>
<span class="c1">#    Lvv = imd.Lvv(t1,t2,eris)</span>
<span class="c1">#    Woooo = imd.cc_Woooo(t1,t2,eris)</span>
<span class="c1">#    Wvvvv = imd.cc_Wvvvv(t1,t2,eris)</span>
<span class="c1">#    Wvoov = imd.cc_Wvoov(t1,t2,eris)</span>
<span class="c1">#    Wvovo = imd.cc_Wvovo(t1,t2,eris)</span>
<span class="c1">#</span>
<span class="c1">#    # Move energy terms to the other side</span>
<span class="c1">#    Foo -= np.diag(np.diag(foo))</span>
<span class="c1">#    Fvv -= np.diag(np.diag(fvv))</span>
<span class="c1">#    Loo -= np.diag(np.diag(foo))</span>
<span class="c1">#    Lvv -= np.diag(np.diag(fvv))</span>
<span class="c1">#</span>
<span class="c1">#    # T1 equation</span>
<span class="c1">#    t1new = np.array(fov).conj()</span>
<span class="c1">#    t1new += -2*einsum(&#39;kc,ka,ic-&gt;ia&#39;,fov,t1,t1)</span>
<span class="c1">#    eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocc*nvir,nvir**2)).reshape(nocc,nvir,nvir,nvir)</span>
<span class="c1">#    t1new +=   einsum(&#39;ac,ic-&gt;ia&#39;,Fvv,t1)</span>
<span class="c1">#    t1new +=  -einsum(&#39;ki,ka-&gt;ia&#39;,Foo,t1)</span>
<span class="c1">#    t1new += 2*einsum(&#39;kc,kica-&gt;ia&#39;,Fov,t2)</span>
<span class="c1">#    t1new +=  -einsum(&#39;kc,ikca-&gt;ia&#39;,Fov,t2)</span>
<span class="c1">#    t1new +=   einsum(&#39;kc,ic,ka-&gt;ia&#39;,Fov,t1,t1)</span>
<span class="c1">#    t1new += 2*einsum(&#39;iack,kc-&gt;ia&#39;,eris.ovvo,t1)</span>
<span class="c1">#    t1new +=  -einsum(&#39;kiac,kc-&gt;ia&#39;,eris.oovv,t1)</span>
<span class="c1">#    t1new += 2*einsum(&#39;kdac,ikcd-&gt;ia&#39;,eris_ovvv,t2)</span>
<span class="c1">#    t1new +=  -einsum(&#39;kcad,ikcd-&gt;ia&#39;,eris_ovvv,t2)</span>
<span class="c1">#    t1new += 2*einsum(&#39;kdac,ic,kd-&gt;ia&#39;,eris_ovvv,t1,t1)</span>
<span class="c1">#    t1new +=  -einsum(&#39;kcad,ic,kd-&gt;ia&#39;,eris_ovvv,t1,t1)</span>
<span class="c1">#    t1new += -2*einsum(&#39;kilc,klac-&gt;ia&#39;,eris.ooov,t2)</span>
<span class="c1">#    t1new +=  einsum(&#39;likc,klac-&gt;ia&#39;,eris.ooov,t2)</span>
<span class="c1">#    t1new += -2*einsum(&#39;kilc,ka,lc-&gt;ia&#39;,eris.ooov,t1,t1)</span>
<span class="c1">#    t1new +=  einsum(&#39;likc,ka,lc-&gt;ia&#39;,eris.ooov,t1,t1)</span>
<span class="c1">#</span>
<span class="c1">#    # T2 equation</span>
<span class="c1">#    t2new = np.array(eris.ovov).transpose(0,2,1,3).conj().copy()</span>
<span class="c1">#    t2new += einsum(&#39;klij,klab-&gt;ijab&#39;,Woooo,t2)</span>
<span class="c1">#    t2new += einsum(&#39;klij,ka,lb-&gt;ijab&#39;,Woooo,t1,t1)</span>
<span class="c1">#    for a in range(nvir):</span>
<span class="c1">#        Wvvvv_a = np.array(Wvvvv[a]).copy()</span>
<span class="c1">#        t2new[:,:,a,:] += einsum(&#39;bcd,ijcd-&gt;ijb&#39;,Wvvvv_a,t2)</span>
<span class="c1">#        t2new[:,:,a,:] += einsum(&#39;bcd,ic,jd-&gt;ijb&#39;,Wvvvv_a,t1,t1)</span>
<span class="c1">#    tmp = einsum(&#39;ac,ijcb-&gt;ijab&#39;,Lvv,t2)</span>
<span class="c1">#    t2new += (tmp + tmp.transpose(1,0,3,2))</span>
<span class="c1">#    tmp = einsum(&#39;ki,kjab-&gt;ijab&#39;,Loo,t2)</span>
<span class="c1">#    t2new -= (tmp + tmp.transpose(1,0,3,2))</span>
<span class="c1">#    tmp2 = np.array(eris_ovvv).transpose(1,3,0,2).conj() \</span>
<span class="c1">#            - einsum(&#39;kibc,ka-&gt;abic&#39;,eris.oovv,t1)</span>
<span class="c1">#    tmp = einsum(&#39;abic,jc-&gt;ijab&#39;,tmp2,t1)</span>
<span class="c1">#    t2new += (tmp + tmp.transpose(1,0,3,2))</span>
<span class="c1">#    tmp2 = np.array(eris.ooov).transpose(3,1,2,0).conj() \</span>
<span class="c1">#            + einsum(&#39;iack,jc-&gt;akij&#39;,eris.ovvo,t1)</span>
<span class="c1">#    tmp = einsum(&#39;akij,kb-&gt;ijab&#39;,tmp2,t1)</span>
<span class="c1">#    t2new -= (tmp + tmp.transpose(1,0,3,2))</span>
<span class="c1">#    tmp = 2*einsum(&#39;akic,kjcb-&gt;ijab&#39;,Wvoov,t2) - einsum(&#39;akci,kjcb-&gt;ijab&#39;,Wvovo,t2)</span>
<span class="c1">#    t2new += (tmp + tmp.transpose(1,0,3,2))</span>
<span class="c1">#    tmp = einsum(&#39;akic,kjbc-&gt;ijab&#39;,Wvoov,t2)</span>
<span class="c1">#    t2new -= (tmp + tmp.transpose(1,0,3,2))</span>
<span class="c1">#    tmp = einsum(&#39;bkci,kjac-&gt;ijab&#39;,Wvovo,t2)</span>
<span class="c1">#    t2new -= (tmp + tmp.transpose(1,0,3,2))</span>
<span class="c1">#</span>
<span class="c1">#    t1new /= eia</span>
<span class="c1">#    t2new /= eijab</span>
<span class="c1">#</span>
<span class="c1">#    time0 = log.timer_debug1(&#39;update t1 t2&#39;, *time0)</span>
<span class="c1">#</span>
<span class="c1">#    return t1new, t2new</span>


<span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fock</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,ia&#39;</span><span class="p">,</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:],</span> <span class="n">t1</span><span class="p">)</span>
    <span class="n">t1t1</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">t1t1</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,iajb&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">tau</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,ibja&#39;</span><span class="p">,</span>  <span class="o">-</span><span class="n">tau</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">real</span>


<div class="viewcode-block" id="RCCSD"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.rccsd.RCCSD">[docs]</a><span class="k">class</span> <span class="nc">RCCSD</span><span class="p">(</span><span class="n">ccsd</span><span class="o">.</span><span class="n">CCSD</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;restricted CCSD with IP-EOM, EA-EOM, EE-EOM, and SF-EOM capabilities</span>

<span class="sd">    Ground-state CCSD is performed in optimized ccsd.CCSD and EOM is performed here.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mo_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ccsd</span><span class="o">.</span><span class="n">CCSD</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">frozen</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_space</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="s1">&#39;max_space&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">dump_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ccsd</span><span class="o">.</span><span class="n">CCSD</span><span class="o">.</span><span class="n">dump_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">init_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">mo_e</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">eia</span> <span class="o">=</span> <span class="n">mo_e</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">mo_e</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="n">eijab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span><span class="n">eia</span><span class="p">,</span><span class="n">eia</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">/</span> <span class="n">eia</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">eris_oovv</span><span class="o">/</span><span class="n">eijab</span>
        <span class="n">wvvoo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">eris_oovv</span>
                  <span class="o">-</span><span class="n">eris_oovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,abij&#39;</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">wvvoo</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Init t2, MP2 energy = </span><span class="si">%.15g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;init mp2&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

    <span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mbpt2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccsd</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">mbpt2</span><span class="p">)</span>
<div class="viewcode-block" id="RCCSD.ccsd"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.rccsd.RCCSD.ccsd">[docs]</a>    <span class="k">def</span> <span class="nf">ccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mbpt2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Ground-state CCSD.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            mbpt2 : bool</span>
<span class="sd">                Use one-shot MBPT2 approximation to CCSD.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eris</span> <span class="o">=</span> <span class="n">eris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_flags</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mbpt2</span><span class="p">:</span>
            <span class="n">cctyp</span> <span class="o">=</span> <span class="s1">&#39;MBPT2&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cctyp</span> <span class="o">=</span> <span class="s1">&#39;CCSD&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> \
                    <span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                           <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">tolnormt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;CCSD converged&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;CCSD not converged&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">e_tot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;E_corr = </span><span class="si">%.16g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;E(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%.16g</span><span class="s1">  E_corr = </span><span class="si">%.16g</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">cctyp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span></div>

    <span class="k">def</span> <span class="nf">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ERIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>

<span class="c1">#    def update_amps(self, t1, t2, eris):</span>
<span class="c1">#        return update_amps(self, t1, t2, eris)</span>

    <span class="k">def</span> <span class="nf">nip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nip</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nip</span>

    <span class="k">def</span> <span class="nf">nea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nea</span> <span class="o">=</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nea</span>

    <span class="k">def</span> <span class="nf">nee</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nee</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nee</span>

<div class="viewcode-block" id="RCCSD.ipccsd"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.rccsd.RCCSD.ipccsd">[docs]</a>    <span class="k">def</span> <span class="nf">ipccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate (N-1)-electron charged excitations via IP-EOM-CCSD.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            nroots : int</span>
<span class="sd">                Number of roots (eigenvalues) requested</span>
<span class="sd">            partition : bool or str</span>
<span class="sd">                Use a matrix-partitioning for the doubles-doubles block.</span>
<span class="sd">                Can be None, &#39;mp&#39; (Moller-Plesset, i.e. orbital energies on the diagonal),</span>
<span class="sd">                or &#39;full&#39; (full diagonal elements).</span>
<span class="sd">            koopmans : bool</span>
<span class="sd">                Calculate Koopmans&#39;-like (quasiparticle) excitations only, targeting via</span>
<span class="sd">                overlap.</span>
<span class="sd">            guess : list of ndarray</span>
<span class="sd">                List of guess vectors to use for targeting via overlap.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nip</span><span class="p">()</span>
        <span class="n">nroots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nroots</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">partition</span><span class="p">:</span>
            <span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">partition</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mp&#39;</span><span class="p">,</span><span class="s1">&#39;full&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span> <span class="o">=</span> <span class="n">partition</span>
        <span class="k">if</span> <span class="n">partition</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ipccsd_diag_matrix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipccsd_diag</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">adiag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ipccsd_diag</span><span class="p">()</span>
        <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
            <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">==</span> <span class="n">nroots</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">koopmans</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">):</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nocc</span><span class="o">-</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">adiag</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span><span class="n">nroots</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">precond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">adiag</span><span class="o">+</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">matvec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lipccsd_matvec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matvec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ipccsd_matvec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="n">eig</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">davidson_nosym1</span>
        <span class="k">if</span> <span class="n">user_guess</span> <span class="ow">or</span> <span class="n">koopmans</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pickeig</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">_gen_x0</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">envs</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">idx</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eip</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span> <span class="n">pick</span><span class="o">=</span><span class="n">pickeig</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eip</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eip</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">convn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">),</span> <span class="n">eip</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;IP root </span><span class="si">%d</span><span class="s1"> E = </span><span class="si">%.16g</span><span class="s1">  qpwt = </span><span class="si">%.6g</span><span class="s1">  conv = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vn</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">nocc</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">convn</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;IP-CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eip</span><span class="p">,</span> <span class="n">evecs</span></div>

    <span class="k">def</span> <span class="nf">ipccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="c1"># Ref: Nooijen and Snijders, J. Chem. Phys. 102, 1681 (1995) Eqs.(8)-(9)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ip_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span><span class="p">)</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ip</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>

        <span class="c1"># 1h-1h block</span>
        <span class="n">Hr1</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ki,k-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="c1">#1h-2h1p block</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ld,ild-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span>  <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kd,kid-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;klid,kld-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wooov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span>    <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lkid,kld-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wooov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>

        <span class="c1"># 2h1p-1h block</span>
        <span class="n">Hr2</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kbij,k-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovoo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="c1"># 2h1p-2h1p block</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
            <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bd,ijd-&gt;ijb&#39;</span><span class="p">,</span><span class="n">fvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ki,kjb-&gt;ijb&#39;</span><span class="p">,</span><span class="n">foo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lj,ilb-&gt;ijb&#39;</span><span class="p">,</span><span class="n">foo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipccsd_diag_matrix2</span><span class="o">*</span><span class="n">r2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bd,ijd-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ki,kjb-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lj,ilb-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;klij,klb-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Woooo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lbdj,ild-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kbdj,kid-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lbjd,ild-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span> <span class="c1">#typo in Ref</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kbid,kjd-&gt;ijb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lkdc,kld-&gt;c&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kldc,kld-&gt;c&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;c,ijcb-&gt;ijb&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ip</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">lipccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ip_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span><span class="p">)</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ip</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>

        <span class="c1"># 1h-1h block</span>
        <span class="n">Hr1</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ki,i-&gt;k&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="c1">#1h-2h1p block</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kbij,ijb-&gt;k&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovoo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>

        <span class="c1"># 2h1p-1h block</span>
        <span class="n">Hr2</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kd,l-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ld,k-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;klid,i-&gt;kld&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wooov</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">r1</span><span class="p">)</span>
        <span class="c1"># 2h1p-2h1p block</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
            <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bd,klb-&gt;kld&#39;</span><span class="p">,</span><span class="n">fvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ki,ild-&gt;kld&#39;</span><span class="p">,</span><span class="n">foo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lj,kjd-&gt;kld&#39;</span><span class="p">,</span><span class="n">foo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipccsd_diag_matrix2</span><span class="o">*</span><span class="n">r2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bd,klb-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ki,ild-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lj,kjd-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lbdj,kjb-&gt;kld&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kbdj,ljb-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;klij,ijd-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Woooo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kbid,ilb-&gt;kld&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijcb,ijb-&gt;c&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lkdc,c-&gt;kld&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">tmp</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ip</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">ipccsd_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ip_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span><span class="p">)</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
        <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>

        <span class="n">Hr1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fvv</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">foo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">foo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Woooo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="p">,:],</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,</span><span class="n">b</span><span class="p">])</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">,:],</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,</span><span class="n">b</span><span class="p">])</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ip</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vector</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nip</span><span class="p">()</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">ipccsd_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipccsd_evals</span><span class="p">,</span> <span class="n">ipccsd_evecs</span><span class="p">,</span> <span class="n">lipccsd_evecs</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip_partition</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">fock</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>

        <span class="n">fov</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
        <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>

        <span class="n">oovv</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eris_ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ovov</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ooov</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vooo</span> <span class="o">=</span> <span class="n">ooov</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vvvo</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">oooo</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">eijkab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">cartesian_prod</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">)]):</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">cartesian_prod</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">)]):</span>
                <span class="n">eijkab</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">foo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">foo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">foo</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">fvv</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">fvv</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>

        <span class="n">ipccsd_evecs</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ipccsd_evecs</span><span class="p">)</span>
        <span class="n">lipccsd_evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lipccsd_evecs</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_eval</span><span class="p">,</span> <span class="n">_evec</span><span class="p">,</span> <span class="n">_levec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ipccsd_evals</span><span class="p">,</span> <span class="n">ipccsd_evecs</span><span class="p">,</span> <span class="n">lipccsd_evecs</span><span class="p">):</span>
            <span class="n">l1</span><span class="p">,</span><span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ip</span><span class="p">(</span><span class="n">_levec</span><span class="p">)</span>
            <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ip</span><span class="p">(</span><span class="n">_evec</span><span class="p">)</span>
            <span class="n">ldotr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l2</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">r2</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">l1</span> <span class="o">/=</span> <span class="n">ldotr</span>
            <span class="n">l2</span> <span class="o">/=</span> <span class="n">ldotr</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">l2</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">l2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

            <span class="n">_eijkab</span> <span class="o">=</span> <span class="n">eijkab</span> <span class="o">+</span> <span class="n">_eval</span>
            <span class="n">_eijkab</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">_eijkab</span>

            <span class="n">lijkab</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,k-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">oovv</span><span class="p">,</span><span class="n">l1</span><span class="p">)</span>
            <span class="n">lijkab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ieab,jke-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">ovvv</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span>
            <span class="n">lijkab</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kjmb,ima-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">ooov</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span>
            <span class="n">lijkab</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijmb,mka-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">ooov</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span>
            <span class="n">lijkab</span> <span class="o">=</span> <span class="n">lijkab</span> <span class="o">+</span> <span class="n">lijkab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbke,m-&gt;bke&#39;</span><span class="p">,</span><span class="n">ovov</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">rijkab</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bke,ijae-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,m-&gt;bej&#39;</span><span class="p">,</span><span class="n">ovvo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">rijkab</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bej,ikae-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnjk,n-&gt;mjk&#39;</span><span class="p">,</span><span class="n">oooo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">rijkab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mjk,imab-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">rijkab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;baei,kje-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">vvvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">rijkab</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bmjk,mia-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">vooo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">rijkab</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bmji,kma-&gt;ijkab&#39;</span><span class="p">,</span><span class="n">vooo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">rijkab</span> <span class="o">=</span> <span class="n">rijkab</span> <span class="o">+</span> <span class="n">rijkab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">lijkab</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">lijkab</span> \
                   <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">lijkab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">lijkab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> \
                   <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">lijkab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">1.</span><span class="o">*</span><span class="n">lijkab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> \
                   <span class="o">+</span> <span class="mf">1.</span><span class="o">*</span><span class="n">lijkab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">deltaE</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijkab,ijkab,ijkab&#39;</span><span class="p">,</span><span class="n">lijkab</span><span class="p">,</span><span class="n">rijkab</span><span class="p">,</span><span class="n">_eijkab</span><span class="p">)</span>
            <span class="n">deltaE</span> <span class="o">=</span> <span class="n">deltaE</span><span class="o">.</span><span class="n">real</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Exc. energy, delta energy = </span><span class="si">%16.12f</span><span class="s2">, </span><span class="si">%16.12f</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">_eval</span><span class="o">+</span><span class="n">deltaE</span><span class="p">,</span> <span class="n">deltaE</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_eval</span><span class="o">+</span><span class="n">deltaE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span>

<div class="viewcode-block" id="RCCSD.eaccsd"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.rccsd.RCCSD.eaccsd">[docs]</a>    <span class="k">def</span> <span class="nf">eaccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">partition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate (N+1)-electron charged excitations via EA-EOM-CCSD.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            See ipccd()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nea</span><span class="p">()</span>
        <span class="n">nroots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nroots</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">partition</span><span class="p">:</span>
            <span class="n">partition</span> <span class="o">=</span> <span class="n">partition</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">partition</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mp&#39;</span><span class="p">,</span><span class="s1">&#39;full&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">=</span> <span class="n">partition</span>
        <span class="k">if</span> <span class="n">partition</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eaccsd_diag_matrix2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eaccsd_diag</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">adiag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eaccsd_diag</span><span class="p">()</span>
        <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
            <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">==</span> <span class="n">nroots</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">koopmans</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">):</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">adiag</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span><span class="n">nroots</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">precond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">adiag</span><span class="o">+</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">davidson_nosym1</span>
        <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">matvec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaccsd_matvec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matvec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eaccsd_matvec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_guess</span> <span class="ow">or</span> <span class="n">koopmans</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pickeig</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">_gen_x0</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">envs</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">idx</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eea</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span> <span class="n">pick</span><span class="o">=</span><span class="n">pickeig</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eea</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eea</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">convn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">),</span> <span class="n">eea</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EA root </span><span class="si">%d</span><span class="s1"> E = </span><span class="si">%.16g</span><span class="s1">  qpwt = </span><span class="si">%.6g</span><span class="s1">  conv = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vn</span><span class="p">[:</span><span class="n">nvir</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">convn</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EA-CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eea</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eea</span><span class="p">,</span> <span class="n">evecs</span></div>

    <span class="k">def</span> <span class="nf">eaccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vector</span><span class="p">):</span>
        <span class="c1"># Ref: Nooijen and Bartlett, J. Chem. Phys. 102, 3629 (1994) Eqs.(30)-(31)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ea_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span><span class="p">)</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ea</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>

        <span class="c1"># Eq. (30)</span>
        <span class="c1"># 1p-1p block</span>
        <span class="n">Hr1</span> <span class="o">=</span>  <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ac,c-&gt;a&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="c1"># 1p-2p1h block</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ld,lad-&gt;a&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ld,lda-&gt;a&#39;</span><span class="p">,</span>  <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;alcd,lcd-&gt;a&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvovv</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">r2</span><span class="p">)</span>
        <span class="c1"># Eq. (31)</span>
        <span class="c1"># 2p1h-1p block</span>
        <span class="n">Hr2</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abcj,c-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvvvo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="c1"># 2p1h-2p1h block</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
            <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ac,jcb-&gt;jab&#39;</span><span class="p">,</span><span class="n">fvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bd,jad-&gt;jab&#39;</span><span class="p">,</span><span class="n">fvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lj,lab-&gt;jab&#39;</span><span class="p">,</span><span class="n">foo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eaccsd_diag_matrix2</span><span class="o">*</span><span class="n">r2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ac,jcb-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span>  <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bd,jad-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lj,lab-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lbdj,lad-&gt;jab&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lajc,lcb-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lbcj,lca-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
                <span class="n">Hr2</span><span class="p">[:,</span><span class="n">a</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcd,jcd-&gt;jb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvvvv</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;klcd,lcd-&gt;k&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;k,kjab-&gt;jab&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ea</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">leaccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vector</span><span class="p">):</span>
        <span class="c1"># Note this is not the same left EA equations used by Nooijen and Bartlett.</span>
        <span class="c1"># Small changes were made so that the same type L2 basis was used for both the</span>
        <span class="c1"># left EA and left IP equations.  You will note more similarity for these</span>
        <span class="c1"># equations to the left IP equations than for the left EA equations by Nooijen.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ea_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span><span class="p">)</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ea</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>

        <span class="c1"># Eq. (30)</span>
        <span class="c1"># 1p-1p block</span>
        <span class="n">Hr1</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ac,a-&gt;c&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="c1"># 1p-2p1h block</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abcj,jab-&gt;c&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvvvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="c1"># Eq. (31)</span>
        <span class="c1"># 2p1h-1p block</span>
        <span class="n">Hr2</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;c,ld-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span>  <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;d,lc-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,alcd-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvovv</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># 2p1h-2p1h block</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
            <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lad,ac-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">fvv</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lcb,bd-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">fvv</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jcd,lj-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">foo</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eaccsd_diag_matrix2</span><span class="o">*</span><span class="n">r2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lad,ac-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lcb,bd-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jcd,lj-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jcb,lbdj-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lajc,jab-&gt;lcb&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lbcj,jab-&gt;lca&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
                <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lb,bcd-&gt;lcd&#39;</span><span class="p">,</span><span class="n">r2</span><span class="p">[:,</span><span class="n">a</span><span class="p">,:],</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvvvv</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijcb,ibc-&gt;j&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kjfe,j-&gt;kef&#39;</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">tmp</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ea</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eaccsd_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ea_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span><span class="p">)</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">fock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
        <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>

        <span class="n">Hr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">!=</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
                <span class="n">_Wvvvva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Wvvvv</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fvv</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fvv</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">foo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Lvv</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Loo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovov</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="n">b</span><span class="p">)</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_Wvvvva</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span><span class="n">t2</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
                        <span class="n">Hr2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Woovv</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">],</span><span class="n">t2</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ea</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_ea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vector</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nvir</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">nvir</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_ea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nea</span><span class="p">()</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">nvir</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">nvir</span><span class="p">:]</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eaccsd_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eaccsd_evals</span><span class="p">,</span> <span class="n">eaccsd_evecs</span><span class="p">,</span> <span class="n">leaccsd_evecs</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ea_partition</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">fock</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>

        <span class="n">fov</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
        <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>

        <span class="n">oovv</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">ovvv</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris_ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vvov</span> <span class="o">=</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ooov</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vooo</span> <span class="o">=</span> <span class="n">ooov</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ovov</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vvvv</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">),</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ovvo</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">eijabc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">cartesian_prod</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">)]):</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">cartesian_prod</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">)]):</span>
                <span class="n">eijabc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">foo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">foo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">fvv</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">fvv</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">-</span> <span class="n">fvv</span><span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

        <span class="n">eaccsd_evecs</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eaccsd_evecs</span><span class="p">)</span>
        <span class="n">leaccsd_evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">leaccsd_evecs</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_eval</span><span class="p">,</span> <span class="n">_evec</span><span class="p">,</span> <span class="n">_levec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">eaccsd_evals</span><span class="p">,</span> <span class="n">eaccsd_evecs</span><span class="p">,</span> <span class="n">leaccsd_evecs</span><span class="p">):</span>
            <span class="n">l1</span><span class="p">,</span><span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ea</span><span class="p">(</span><span class="n">_levec</span><span class="p">)</span>
            <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ea</span><span class="p">(</span><span class="n">_evec</span><span class="p">)</span>
            <span class="n">ldotr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l2</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">r2</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">l1</span> <span class="o">/=</span> <span class="n">ldotr</span>
            <span class="n">l2</span> <span class="o">/=</span> <span class="n">ldotr</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">l2</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">l2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">_eijabc</span> <span class="o">=</span> <span class="n">eijabc</span> <span class="o">+</span> <span class="n">_eval</span>
            <span class="n">_eijabc</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">_eijabc</span>

            <span class="n">lijabc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;c,ijab-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">oovv</span><span class="p">)</span>
            <span class="n">lijabc</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jima,mbc-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">ooov</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span>
            <span class="n">lijabc</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ieab,jec-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">ovvv</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span>
            <span class="n">lijabc</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jebc,iae-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">ovvv</span><span class="p">,</span><span class="n">l2</span><span class="p">)</span>
            <span class="n">lijabc</span> <span class="o">=</span> <span class="n">lijabc</span> <span class="o">+</span> <span class="n">lijabc</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcef,f-&gt;bce&#39;</span><span class="p">,</span><span class="n">vvvv</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">rijabc</span> <span class="o">=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bce,ijae-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcje,e-&gt;mcj&#39;</span><span class="p">,</span><span class="n">ovov</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">rijabc</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcj,imab-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,e-&gt;mbj&#39;</span><span class="p">,</span><span class="n">ovvo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
            <span class="n">rijabc</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbj,imac-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">rijabc</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;amij,mbc-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">vooo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">rijabc</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcje,iae-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">vvov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">rijabc</span> <span class="o">+=</span> <span class="o">-</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abie,jec-&gt;ijabc&#39;</span><span class="p">,</span><span class="n">vvov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">rijabc</span> <span class="o">=</span> <span class="n">rijabc</span> <span class="o">+</span> <span class="n">rijabc</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">lijabc</span> <span class="o">=</span>  <span class="mf">4.</span><span class="o">*</span><span class="n">lijabc</span> \
                    <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">lijabc</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> \
                    <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">lijabc</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> \
                    <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">lijabc</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="mf">1.</span><span class="o">*</span><span class="n">lijabc</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="mf">1.</span><span class="o">*</span><span class="n">lijabc</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">deltaE</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijabc,ijabc,ijabc&#39;</span><span class="p">,</span><span class="n">lijabc</span><span class="p">,</span><span class="n">rijabc</span><span class="p">,</span><span class="n">_eijabc</span><span class="p">)</span>
            <span class="n">deltaE</span> <span class="o">=</span> <span class="n">deltaE</span><span class="o">.</span><span class="n">real</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Exc. energy, delta energy = </span><span class="si">%16.12f</span><span class="s2">, </span><span class="si">%16.12f</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">_eval</span><span class="o">+</span><span class="n">deltaE</span><span class="p">,</span> <span class="n">deltaE</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_eval</span><span class="o">+</span><span class="n">deltaE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span>

    <span class="c1">#TODO: double spin-flip EOM-EE</span>
<div class="viewcode-block" id="RCCSD.eeccsd"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.rccsd.RCCSD.eeccsd">[docs]</a>    <span class="k">def</span> <span class="nf">eeccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate N-electron neutral excitations via EE-EOM-CCSD.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            nroots : int</span>
<span class="sd">                Number of roots (eigenvalues) requested</span>
<span class="sd">            koopmans : bool</span>
<span class="sd">                Calculate Koopmans&#39;-like (1p1h) excitations only, targeting via</span>
<span class="sd">                overlap.</span>
<span class="sd">            guess : list of ndarray</span>
<span class="sd">                List of guess vectors to use for targeting via overlap.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">spinvec_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nee</span><span class="p">()</span>
        <span class="n">nroots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nroots</span><span class="p">,</span> <span class="n">spinvec_size</span><span class="p">)</span>

        <span class="n">diag_eeS</span><span class="p">,</span> <span class="n">diag_eeT</span><span class="p">,</span> <span class="n">diag_sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeccsd_diag</span><span class="p">()</span>
        <span class="n">guess_eeS</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guess_eeT</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guess_sf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">guess</span> <span class="ow">and</span> <span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">spinvec_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">elif</span> <span class="n">guess</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag_eeS</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">guess_eeS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag_eeT</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">guess_eeT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">guess_sf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="n">nroots_eeS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_eeS</span><span class="p">)</span>
            <span class="n">nroots_eeT</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_eeT</span><span class="p">)</span>
            <span class="n">nroots_sf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_sf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deeS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">diag_eeS</span><span class="p">)[:</span><span class="n">nroots</span><span class="p">]</span>
            <span class="n">deeT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">diag_eeT</span><span class="p">)[:</span><span class="n">nroots</span><span class="p">]</span>
            <span class="n">dsf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">diag_sf</span><span class="p">)[:</span><span class="n">nroots</span><span class="p">]</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">deeS</span><span class="p">,</span><span class="n">deeT</span><span class="p">,</span><span class="n">dsf</span><span class="p">,</span><span class="n">dsf</span><span class="p">]))[</span><span class="n">nroots</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nroots_eeS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">deeS</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">)</span>
            <span class="n">nroots_eeT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">deeT</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">)</span>
            <span class="n">nroots_sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dsf</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">)</span>
            <span class="n">guess_eeS</span> <span class="o">=</span> <span class="n">guess_eeT</span> <span class="o">=</span> <span class="n">guess_sf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">e2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nroots_eeS</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eomee_ccsd_singlet</span><span class="p">(</span><span class="n">nroots_eeS</span><span class="p">,</span> <span class="n">koopmans</span><span class="p">,</span> <span class="n">guess_eeS</span><span class="p">,</span> <span class="n">diag_eeS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nroots_eeS</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">e0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="p">[</span><span class="n">e0</span><span class="p">],</span> <span class="p">[</span><span class="n">v0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nroots_eeT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eomee_ccsd_triplet</span><span class="p">(</span><span class="n">nroots_eeT</span><span class="p">,</span> <span class="n">koopmans</span><span class="p">,</span> <span class="n">guess_eeT</span><span class="p">,</span> <span class="n">diag_eeT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nroots_eeT</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">e2</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2</span><span class="p">],</span> <span class="p">[</span><span class="n">v2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nroots_sf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eomsf_ccsd</span><span class="p">(</span><span class="n">nroots_sf</span><span class="p">,</span> <span class="n">koopmans</span><span class="p">,</span> <span class="n">guess_sf</span><span class="p">,</span> <span class="n">diag_sf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nroots_sf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">[</span><span class="n">e1</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">]</span>
            <span class="c1"># The associated solution</span>
            <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
            <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">e0</span><span class="p">,</span><span class="n">e2</span><span class="p">,</span><span class="n">e1</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">v1</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">e</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">eomee_ccsd_singlet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeccsd_diag</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nmo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span>

        <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
            <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">==</span> <span class="n">nroots</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">koopmans</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">nmo</span><span class="p">,</span> <span class="n">nocc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">nroots</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[:</span><span class="n">nroots</span><span class="p">]:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">precond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">diag</span><span class="o">+</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">davidson_nosym1</span>
        <span class="n">matvec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eomee_ccsd_matvec_singlet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_guess</span> <span class="ow">or</span> <span class="n">koopmans</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pickeig</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">_gen_x0</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">envs</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">idx</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span> <span class="n">pick</span><span class="o">=</span><span class="n">pickeig</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eee</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">convn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">),</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="n">nmo</span><span class="p">,</span> <span class="n">nocc</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-EE singlet root </span><span class="si">%d</span><span class="s1"> E = </span><span class="si">%.16g</span><span class="s1">  qpwt = </span><span class="si">%.6g</span><span class="s1">  conv = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">convn</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-EE-CCSD singlet&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span>

    <span class="k">def</span> <span class="nf">eomee_ccsd_triplet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeccsd_diag</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>

        <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
            <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">==</span> <span class="n">nroots</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">koopmans</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_triplet</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">nroots</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[:</span><span class="n">nroots</span><span class="p">]:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">precond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">diag</span><span class="o">+</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">davidson_nosym1</span>
        <span class="n">matvec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eomee_ccsd_matvec_triplet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_guess</span> <span class="ow">or</span> <span class="n">koopmans</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pickeig</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">_gen_x0</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">envs</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">idx</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span> <span class="n">pick</span><span class="o">=</span><span class="n">pickeig</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eee</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">convn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">),</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_triplet</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-EE triplet root </span><span class="si">%d</span><span class="s1"> E = </span><span class="si">%.16g</span><span class="s1">  qpwt = </span><span class="si">%.6g</span><span class="s1">  conv = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">convn</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-EE-CCSD triplet&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span>

    <span class="k">def</span> <span class="nf">eomsf_ccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeccsd_diag</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>

        <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
            <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">==</span> <span class="n">nroots</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">koopmans</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">nroots</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[:</span><span class="n">nroots</span><span class="p">]:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">precond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">diag</span><span class="o">+</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">davidson_nosym1</span>
        <span class="n">matvec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eomsf_ccsd_matvec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_guess</span> <span class="ow">or</span> <span class="n">koopmans</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pickeig</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">_gen_x0</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">envs</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">idx</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span> <span class="n">pick</span><span class="o">=</span><span class="n">pickeig</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="n">matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eee</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

<span class="c1"># EOM-SF solutions are degenerated.  Here the solution (r1ab, r2baaa, r2aaba)</span>
<span class="c1"># is computed.  The associated solution is</span>
<span class="c1"># (r1ba, r2abbb, r2bbab) = (-r1ab,-r2baaa, r2aaba)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">convn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">),</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
            <span class="n">qpwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-SF root </span><span class="si">%d</span><span class="s1"> E = </span><span class="si">%.16g</span><span class="s1">  qpwt = </span><span class="si">%.6g</span><span class="s1">  conv = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">qpwt</span><span class="p">,</span> <span class="n">convn</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-SF-CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span>

    <span class="k">def</span> <span class="nf">eomee_ccsd_matvec_singlet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ee_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ee</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="n">r2</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr1</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ie-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,ma-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>

        <span class="n">Hr2</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Hr2</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span>   <span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr2</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span>   <span class="p">,</span> <span class="n">r2</span><span class="p">)</span>

        <span class="n">tau2</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocc*nvir,nvir**2)).reshape(nocc,nvir,nvir,nvir)</span>
        <span class="c1">#:Hr1 += lib.einsum(&#39;mfae,imef-&gt;ia&#39;, eris_ovvv, rho)</span>
        <span class="c1">#:tmp = lib.einsum(&#39;meaf,ijef-&gt;maij&#39;, eris_ovvv, tau2)</span>
        <span class="c1">#:Hr2 -= lib.einsum(&#39;ma,mbij-&gt;ijab&#39;, t1, tmp)</span>
        <span class="c1">#:tmp  = lib.einsum(&#39;meaf,me-&gt;af&#39;, eris_ovvv, r1) * 2</span>
        <span class="c1">#:tmp -= lib.einsum(&#39;mfae,me-&gt;af&#39;, eris_ovvv, r1)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,imef-&gt;ia&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">rho</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijef-&gt;maij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)</span>
            <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">tmp</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">tmp</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;af,ijfb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbij,ma-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVoO</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>

        <span class="n">Hr1</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,mnae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nmie,me-&gt;ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">tmp</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,me-&gt;ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni,njab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">nocc</span><span class="p">):</span>
            <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ejab,ie-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]),</span> <span class="n">r1</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>

        <span class="n">oVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imea-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">tmp</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">oVvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">)</span> <span class="o">+</span> <span class="n">oVVo</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">oVVo</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;maei,me-&gt;ia&#39;</span><span class="p">,</span> <span class="n">oVvO</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">oVvO</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
        <span class="n">oVvO</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,ijef-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nemf,imef-&gt;ni&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,ni-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,miab-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tmp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfne,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">tmp</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">tmp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;en,nb-&gt;eb&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mnbf-&gt;eb&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eb,ijea-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_vvvv = ao2mo.restore(1,np.asarray(eris.vvvv),t1.shape[1])</span>
        <span class="c1">#:Hr2 += lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tau2, eris_vvvv) * .5</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">_add_vvvv_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Hr2</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr2</span> <span class="o">=</span> <span class="n">Hr2</span> <span class="o">+</span> <span class="n">Hr2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span> <span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eomee_ccsd_matvec_triplet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ee_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ee</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_triplet</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">r2aa</span><span class="p">,</span> <span class="n">r2ab</span> <span class="o">=</span> <span class="n">r2</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">r2aa</span> <span class="o">+</span> <span class="n">r2ab</span>

        <span class="n">Hr1</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ie-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,ma-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,iMaE-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>

        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">25</span>
        <span class="n">Hr2ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiJ,mNaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;BE,iJaE-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJ,iMaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>

        <span class="n">tau2ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tau2ab</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">tau2ab</span><span class="o">+=</span> <span class="n">r2ab</span>
        <span class="n">tau2aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tau2aa</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tau2aa</span> <span class="o">=</span> <span class="n">tau2aa</span> <span class="o">-</span> <span class="n">tau2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tau2aa</span><span class="o">+=</span> <span class="n">r2aa</span>
        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocc*nvir,nvir**2)).reshape(nocc,nvir,nvir,nvir)</span>
        <span class="c1">#:Hr1 += lib.einsum(&#39;mfae,imef-&gt;ia&#39;, eris_ovvv, theta)</span>
        <span class="c1">#:tmpaa = lib.einsum(&#39;meaf,ijef-&gt;maij&#39;, eris_ovvv, tau2aa)</span>
        <span class="c1">#:tmpab = lib.einsum(&#39;meAF,iJeF-&gt;mAiJ&#39;, eris_ovvv, tau2ab)</span>
        <span class="c1">#:tmp1 = lib.einsum(&#39;mfae,me-&gt;af&#39;, eris_ovvv, r1)</span>
        <span class="c1">#:Hr2aa+= lib.einsum(&#39;mb,maij-&gt;ijab&#39;, t1*.5, tmpaa)</span>
        <span class="c1">#:Hr2ab-= lib.einsum(&#39;mb,mAiJ-&gt;iJbA&#39;, t1, tmpab)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,imef-&gt;ia&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">theta</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijef-&gt;maij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2aa</span><span class="p">)</span>
            <span class="n">tmpab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meAF,iJeF-&gt;mAiJ&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2ab</span><span class="p">)</span>
            <span class="n">tmp1</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmpaa</span><span class="p">)</span>
            <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mAiJ-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmpab</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">tmpab</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tmpa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,me-&gt;ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">tmp</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni,njab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;af,ijfb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbij,ma-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVoO</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">nocc</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ejab,ie-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]),</span> <span class="n">r1</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>

        <span class="n">oVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;maei,me-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MBEJ,iMEa-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbeJ,iMeA-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">oVVo</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">oVVo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Hr1</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,mnae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">tmp</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,ijef-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2aa</span><span class="p">)</span>
        <span class="n">tmpab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNF,iJeF-&gt;mNiJ&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2ab</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpaa</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiJ,mNaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tmpab</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">tmpab</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tmpa</span> <span class="o">=</span> <span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,imfe-&gt;ni&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,ni-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">)</span>
        <span class="n">tmp</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">tmpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;en,nb-&gt;eb&#39;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmpa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mnbf-&gt;eb&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eb,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">tmp</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_vvvv = ao2mo.restore(1,np.asarray(eris.vvvv),t1.shape[1])</span>
        <span class="c1">#:Hr2aa += lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tau2aa, eris_vvvv) * .25</span>
        <span class="c1">#:Hr2ab += lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tau2ab, eris_vvvv) * .5</span>
        <span class="n">tau2aa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">_add_vvvv_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2aa</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Hr2aa</span><span class="p">)</span>
        <span class="n">_add_vvvv_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2ab</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Hr2ab</span><span class="p">)</span>
        <span class="n">tau2aa</span> <span class="o">=</span> <span class="n">tau2ab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">-</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">-</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">=</span> <span class="n">Hr2ab</span> <span class="o">-</span> <span class="n">Hr2ab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_triplet</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span> <span class="p">(</span><span class="n">Hr2aa</span><span class="p">,</span><span class="n">Hr2ab</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vector</span>

<div class="viewcode-block" id="RCCSD.eomsf_ccsd_matvec"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.rccsd.RCCSD.eomsf_ccsd_matvec">[docs]</a>    <span class="k">def</span> <span class="nf">eomsf_ccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Spin flip EOM-CCSD&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ee_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ee</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">r2baaa</span><span class="p">,</span> <span class="n">r2aaba</span> <span class="o">=</span> <span class="n">r2</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">Hr1</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ie-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,ma-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,miab-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,miab-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijea-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijea-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>

        <span class="n">tau2baaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tau2baaa</span> <span class="o">+=</span> <span class="n">r2baaa</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">tau2baaa</span> <span class="o">=</span> <span class="n">tau2baaa</span> <span class="o">-</span> <span class="n">tau2baaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tau2aaba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tau2aaba</span> <span class="o">+=</span> <span class="n">r2aaba</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">tau2aaba</span> <span class="o">=</span> <span class="n">tau2aaba</span> <span class="o">-</span> <span class="n">tau2aaba</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocc*nvir,nvir**2)).reshape(nocc,nvir,nvir,nvir)</span>
        <span class="c1">#:Hr1 += einsum(&#39;mfae,imef-&gt;ia&#39;, eris_ovvv, r2baaa)</span>
        <span class="c1">#:Hr1 += einsum(&#39;mfae,imef-&gt;ia&#39;, eris_ovvv, r2aaba)</span>
        <span class="c1">#:tmp1aaba = lib.einsum(&#39;meaf,ijef-&gt;maij&#39;, eris_ovvv, tau2baaa)</span>
        <span class="c1">#:tmp1baaa = lib.einsum(&#39;meaf,ijef-&gt;maij&#39;, eris_ovvv, tau2aaba)</span>
        <span class="c1">#:tmp1abaa = lib.einsum(&#39;meaf,ijfe-&gt;maij&#39;, eris_ovvv, tau2aaba)</span>
        <span class="c1">#:tmp2aaba = lib.einsum(&#39;meaf,ijfe-&gt;maij&#39;, eris_ovvv, tau2baaa)</span>
        <span class="c1">#:Hr2baaa -= lib.einsum(&#39;mb,maij-&gt;ijab&#39;, t1*.5, tmp2aaba)</span>
        <span class="c1">#:Hr2aaba -= lib.einsum(&#39;mb,maij-&gt;ijab&#39;, t1*.5, tmp1abaa)</span>
        <span class="c1">#:Hr2baaa -= lib.einsum(&#39;mb,maij-&gt;ijba&#39;, t1*.5, tmp1aaba)</span>
        <span class="c1">#:Hr2aaba -= lib.einsum(&#39;mb,maij-&gt;ijba&#39;, t1*.5, tmp1baaa)</span>
        <span class="c1">#:tmp = lib.einsum(&#39;mfae,me-&gt;af&#39;, eris_ovvv, r1)</span>
        <span class="c1">#:tmp = lib.einsum(&#39;af,jibf-&gt;ijab&#39;, tmp, t2)</span>
        <span class="c1">#:Hr2baaa -= tmp</span>
        <span class="c1">#:Hr2aaba -= tmp</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,imef-&gt;ia&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,imef-&gt;ia&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijef-&gt;maij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2baaa</span><span class="p">)</span>
            <span class="n">tmp1baaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijef-&gt;maij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">)</span>
            <span class="n">tmp1abaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijfe-&gt;maij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">)</span>
            <span class="n">tmp2aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijfe-&gt;maij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2baaa</span><span class="p">)</span>
            <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp2aaba</span><span class="p">)</span>
            <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp1abaa</span><span class="p">)</span>
            <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maij-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp1aaba</span><span class="p">)</span>
            <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maij-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp1baaa</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;af,jibf-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">tmp</span>
            <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">tmp</span>
            <span class="n">tmp1aaba</span> <span class="o">=</span> <span class="n">tmp1baaa</span> <span class="o">=</span> <span class="n">tmp1abaa</span> <span class="o">=</span> <span class="n">tmp2aaba</span> <span class="o">=</span> <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbij,ma-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVoO</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">tmp</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,mnae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,mnae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,me-&gt;ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni,njab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">tmp</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">tmp</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">nocc</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ejab,ie-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]),</span> <span class="n">r1</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">tmp</span>
            <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">oVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;maei,me-&gt;ia&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,miea-&gt;jiba&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,miea-&gt;jiba&#39;</span><span class="p">,</span> <span class="n">oVVo</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">oVvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">oVvO</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">oVvO</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">oVvO</span> <span class="o">+=</span> <span class="n">oVVo</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">oVvO</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">oVvO</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">oVvO</span> <span class="o">=</span> <span class="n">oVVo</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmp1baaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,ijef-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">)</span>
        <span class="n">tmp1aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,ijef-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2baaa</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp1aaba</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp1baaa</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="n">tmp1baaa</span> <span class="o">=</span> <span class="n">tmp1aaba</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">rhoaaba</span> <span class="o">=</span> <span class="n">r2aaba</span> <span class="o">+</span> <span class="n">r2baaa</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nfme,imfe-&gt;ni&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">rhoaaba</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,ni-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imba-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imba-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;en,nb-&gt;eb&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mnbf-&gt;eb&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">rhoaaba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ea,ijbe-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ea,ijbe-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">rhoaaba</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_vvvv = ao2mo.restore(1,np.asarray(eris.vvvv),t1.shape[1])</span>
        <span class="c1">#:Hr2baaa += .5*lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tau2baaa, eris_vvvv)</span>
        <span class="c1">#:Hr2aaba += .5*lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tau2aaba, eris_vvvv)</span>
        <span class="n">_add_vvvv_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Hr2aaba</span><span class="p">)</span>
        <span class="n">tau2baaa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">_add_vvvv1_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2baaa</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Hr2baaa</span><span class="p">)</span>
        <span class="n">tau2aaba</span> <span class="o">=</span> <span class="n">tau2baaa</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="n">Hr2baaa</span> <span class="o">-</span> <span class="n">Hr2baaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">=</span> <span class="n">Hr2aaba</span> <span class="o">-</span> <span class="n">Hr2aaba</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_eomsf</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span> <span class="p">(</span><span class="n">Hr2baaa</span><span class="p">,</span><span class="n">Hr2aaba</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vector</span></div>

    <span class="k">def</span> <span class="nf">eeccsd_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ee_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ee</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">Fo</span> <span class="o">=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">Fv</span> <span class="o">=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">Wovab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">)</span>
        <span class="n">Wovaa</span> <span class="o">=</span> <span class="n">Wovab</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">)</span>

        <span class="n">eia</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">Fv</span><span class="p">)</span>
        <span class="n">Hr1aa</span> <span class="o">=</span> <span class="n">eia</span> <span class="o">+</span> <span class="n">Wovaa</span>
        <span class="n">Hr1ab</span> <span class="o">=</span> <span class="n">eia</span> <span class="o">+</span> <span class="n">Wovab</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">Wvvab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,manb-&gt;ab&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">Wvvaa</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">Wvvab</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnba,manb-&gt;ab&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">ijb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iejb,ijeb-&gt;ijb&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;iJB+a-&gt;iJaB&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">ijb</span><span class="p">,</span> <span class="n">Fv</span><span class="p">)</span>
        <span class="n">jab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kajb,kjab-&gt;jab&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i-jab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">jab</span><span class="p">)</span>

        <span class="n">jib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iejb,ijbe-&gt;jib&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">jib</span> <span class="o">=</span> <span class="n">jib</span> <span class="o">+</span> <span class="n">jib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">jib</span><span class="o">-=</span> <span class="n">ijb</span> <span class="o">+</span> <span class="n">ijb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">jba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kajb,jkab-&gt;jba&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">jba</span> <span class="o">=</span> <span class="n">jba</span> <span class="o">+</span> <span class="n">jba</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">jba</span><span class="o">-=</span> <span class="n">jab</span> <span class="o">+</span> <span class="n">jab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;jib+a-&gt;jiba&#39;</span><span class="p">,</span> <span class="n">jib</span><span class="p">,</span> <span class="n">Fv</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+jba-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">jba</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ijb+a-&gt;ijba&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">ijb</span><span class="p">,</span> <span class="n">Fv</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="n">Hr2baaa</span> <span class="o">+</span> <span class="n">Hr2baaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2baaa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+jab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">jba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span><span class="o">-=</span> <span class="n">Fo</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i-jab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">jab</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">=</span> <span class="n">Hr2aaba</span> <span class="o">+</span> <span class="n">Hr2aaba</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2aaba</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ijb+a-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">jib</span><span class="p">,</span> <span class="n">Fv</span><span class="p">)</span>
        <span class="n">Hr2aaba</span><span class="o">+=</span> <span class="n">Fv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">=</span> <span class="n">Hr2ab</span> <span class="o">+</span> <span class="n">Hr2ab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">+</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">+</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>

        <span class="n">Wooab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">)</span>
        <span class="n">Wooaa</span> <span class="o">=</span> <span class="n">Wooab</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijji-&gt;ij&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wooaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wooab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wooab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wooaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocc*nvir,nvir**2)).reshape(nocc,nvir,nvir,nvir)</span>
        <span class="c1">#:tmp = np.einsum(&#39;mb,mbaa-&gt;ab&#39;, t1, eris_ovvv)</span>
        <span class="c1">#:Wvvaa += np.einsum(&#39;mb,maab-&gt;ab&#39;, t1, eris_ovvv)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mbaa-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">Wvvaa</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maab-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Wvvaa</span> <span class="o">-=</span> <span class="n">tmp</span>
        <span class="n">Wvvab</span> <span class="o">-=</span> <span class="n">tmp</span>
        <span class="n">Wvvab</span> <span class="o">-=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wvvaa</span> <span class="o">=</span> <span class="n">Wvvaa</span> <span class="o">+</span> <span class="n">Wvvaa</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#:eris_vvvv = ao2mo.restore(1,np.asarray(eris.vvvv),t1.shape[1])</span>
        <span class="c1">#:tmp = np.einsum(&#39;aabb-&gt;ab&#39;, eris_vvvv)</span>
        <span class="c1">#:Wvvaa += tmp</span>
        <span class="c1">#:Wvvaa -= np.einsum(&#39;abba-&gt;ab&#39;, eris_vvvv)</span>
        <span class="c1">#:Wvvab += tmp</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bb-&gt;b&#39;</span><span class="p">,</span> <span class="n">vvv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Wvvaa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span>
            <span class="n">Wvvab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bb-&gt;b&#39;</span><span class="p">,</span> <span class="n">vvv</span><span class="p">[:,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Wvvaa</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp</span>
            <span class="n">Wvvaa</span><span class="p">[:</span><span class="n">i</span>  <span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wvvaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wvvab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wvvaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wvvab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

        <span class="n">vec_eeS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">Hr1aa</span><span class="p">,</span> <span class="n">Hr2ab</span><span class="p">)</span>
        <span class="n">vec_eeT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_triplet</span><span class="p">(</span><span class="n">Hr1aa</span><span class="p">,</span> <span class="p">(</span><span class="n">Hr2aa</span><span class="p">,</span><span class="n">Hr2ab</span><span class="p">))</span>
        <span class="n">vec_sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_eomsf</span><span class="p">(</span><span class="n">Hr1ab</span><span class="p">,</span> <span class="p">(</span><span class="n">Hr2baaa</span><span class="p">,</span><span class="n">Hr2aaba</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vec_eeS</span><span class="p">,</span> <span class="n">vec_eeT</span><span class="p">,</span> <span class="n">vec_sf</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">[</span><span class="n">nov</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">nmo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="k">if</span> <span class="n">nmo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nmo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">t2tril</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">nov</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">oidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">t2tril</span><span class="p">,</span> <span class="n">oidx</span><span class="p">,</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">t2tril</span><span class="p">,</span> <span class="n">filltriu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">t2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_ee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_ee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_eomsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">t2baaa</span><span class="p">,</span> <span class="n">t2aaba</span> <span class="o">=</span> <span class="n">t2</span>

        <span class="n">nbaaa</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">naaba</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">nbaaa</span> <span class="o">+</span> <span class="n">naaba</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">t2baaa</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">t1</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">pvec</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>

        <span class="n">t2baaa</span> <span class="o">=</span> <span class="n">t2baaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">t2aaba</span> <span class="o">=</span> <span class="n">t2aaba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">otril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">oidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">vidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">pvec</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">t2aaba</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nvir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="k">if</span> <span class="n">nvir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nmo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span>
            <span class="n">nvir</span> <span class="o">=</span> <span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pvec</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>

        <span class="n">nbaaa</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">naaba</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span>
        <span class="n">t2baaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">t2aaba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">otril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">oidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">vidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">pvec</span><span class="p">[:</span><span class="n">nbaaa</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="p">:</span><span class="n">nbaaa</span><span class="o">+</span><span class="n">naaba</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2aaba</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2aaba</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">)</span>
        <span class="n">t2baaa</span> <span class="o">=</span> <span class="n">t2baaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">t2aaba</span> <span class="o">=</span> <span class="n">t2aaba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span> <span class="n">t2aaba</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_s4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">otril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">otril</span> <span class="o">=</span> <span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span> <span class="o">+</span> <span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span> <span class="o">+</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">otril</span><span class="p">,</span> <span class="n">vtril</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">[</span><span class="n">nov</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_s4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nvir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="k">if</span> <span class="n">nvir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">_unpack_4fold</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">nov</span><span class="p">:</span><span class="n">size</span><span class="p">],</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_triplet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
        <span class="n">size1</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size1</span> <span class="o">+</span> <span class="n">nov</span><span class="o">*</span><span class="p">(</span><span class="n">nov</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_s4</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">t2ab</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nov</span><span class="p">,</span><span class="n">nov</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">t2ab</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">[</span><span class="n">size1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_triplet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nvir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="k">if</span> <span class="n">nvir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
        <span class="n">size1</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">size1</span> <span class="o">+</span> <span class="n">nov</span><span class="o">*</span><span class="p">(</span><span class="n">nov</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_s4</span><span class="p">(</span><span class="n">vector</span><span class="p">[:</span><span class="n">size1</span><span class="p">],</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="n">t2ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">size1</span><span class="p">:</span><span class="n">size</span><span class="p">],</span> <span class="n">filltriu</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t2ab</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="p">(</span><span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_ERIS</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;incore&#39;</span><span class="p">,</span>
                 <span class="n">ao2mofn</span><span class="o">=</span><span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">mo_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">ccsd</span><span class="o">.</span><span class="n">_mo_without_core</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If mo_coeff is not canonical orbital</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">ccsd</span><span class="o">.</span><span class="n">_mo_without_core</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span>
        <span class="n">fockao</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">()</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fock</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fockao</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">))</span>

        <span class="n">nocc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nmo</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nmo</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">mem_incore</span><span class="p">,</span> <span class="n">mem_outcore</span><span class="p">,</span> <span class="n">mem_basic</span> <span class="o">=</span> <span class="n">_mem_usage</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;incore&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mem_incore</span><span class="o">+</span><span class="n">mem_now</span> <span class="o">&lt;</span> <span class="n">cc</span><span class="o">.</span><span class="n">max_memory</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">incore_anyway</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ao2mofn</span> <span class="o">==</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">eri</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ao2mofn</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">),</span> <span class="n">nmo</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">eri</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ao2mofn</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">nmo</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eri</span> <span class="o">=</span> <span class="n">ao2mofn</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">mo_coeff</span><span class="p">,</span><span class="n">mo_coeff</span><span class="p">,</span><span class="n">mo_coeff</span><span class="p">,</span><span class="n">mo_coeff</span><span class="p">),</span> <span class="n">compact</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mo_coeff</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">:</span> <span class="n">eri</span> <span class="o">=</span> <span class="n">eri</span><span class="o">.</span><span class="n">real</span>
                <span class="n">eri</span> <span class="o">=</span> <span class="n">eri</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nmo</span><span class="p">,)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">eri</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">nvir</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="p">,</span> <span class="s1">&#39;with_df&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">orbo</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,:</span><span class="n">nocc</span><span class="p">]</span>
            <span class="n">orbv</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">ds_type</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
            <span class="n">nvv</span> <span class="o">=</span> <span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oooo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovoo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oovo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oovv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovvo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovvv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvv</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="c1">#self.vvvv = self.feri.create_dataset(&#39;vvvv&#39;, (nvir,nvir,nvir,nvir), ds_type)</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># &lt;ij||pq&gt; = &lt;ij|pq&gt; - &lt;ij|qp&gt; = (ip|jq) - (iq|jp)</span>
            <span class="n">tmpfile2</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbo</span><span class="p">,</span><span class="n">mo_coeff</span><span class="p">,</span><span class="n">mo_coeff</span><span class="p">,</span><span class="n">mo_coeff</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">nmo</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nmo</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">])</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming oopq, ovpq&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>

<span class="c1">#            ao2mo.full(cc.mol, orbv, tmpfile2.name, dataname=&#39;vvvv&#39;)</span>
<span class="c1">#            with h5py.File(tmpfile2.name) as f:</span>
<span class="c1">#                self.feri[&#39;vvvv&#39;] = ao2mo.restore(1, f[&#39;vvvv&#39;], nvir)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">orbv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">,</span> <span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;vvvv&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">[</span><span class="s1">&#39;vvvv&#39;</span><span class="p">]</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming vvvv&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD integral transformation&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_IMDS</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">t1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">t2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eris</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">eris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ip_imds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ea_imds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ee_imds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared_2e</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_make_shared_1e</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Loo</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Loo</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lvv</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Lvv</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">cc_Fov</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD shared one-electron intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_shared_2e</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="c1"># 2 virtuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wovov</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wovov</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wovvo</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Woovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD shared two-electron intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_partition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_shared_1e</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared_2e</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">ip_partition</span> <span class="o">!=</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_shared_2e</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared_2e</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>

        <span class="c1"># 0 or 1 virtuals</span>
        <span class="k">if</span> <span class="n">ip_partition</span> <span class="o">!=</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Woooo</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Woooo</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wooov</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wooov</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wovoo</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wovoo</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ip_imds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD IP intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_ea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ea_partition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_shared_1e</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared_2e</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">ea_partition</span> <span class="o">!=</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_shared_2e</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared_2e</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>

        <span class="c1"># 3 or 4 virtuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wvovv</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wvovv</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ea_partition</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">t1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wvvvo</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wvvvo</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wvvvv</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wvvvv</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Wvvvo</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">Wvvvo</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Wvvvv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ea_imds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD EA intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">make_ee</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;vOvV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>

        <span class="n">foo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="n">fvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>

        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocc*nvir,nvir**2)).reshape(nocc,nvir,nvir,nvir)</span>
        <span class="c1">#:self.Fvv  = np.einsum(&#39;mf,mfae-&gt;ae&#39;, t1, eris_ovvv) * 2</span>
        <span class="c1">#:self.Fvv -= np.einsum(&#39;mf,meaf-&gt;ae&#39;, t1, eris_ovvv)</span>
        <span class="c1">#:self.woVvO = lib.einsum(&#39;jf,mebf-&gt;mbej&#39;, t1, eris_ovvv)</span>
        <span class="c1">#:self.woVVo = lib.einsum(&#39;jf,mfbe-&gt;mbej&#39;,-t1, eris_ovvv)</span>
        <span class="c1">#:tau = make_tau(t2, t1, t1)</span>
        <span class="c1">#:self.woVoO  = 0.5 * lib.einsum(&#39;mebf,ijef-&gt;mbij&#39;, eris_ovvv, tau)</span>
        <span class="c1">#:self.woVoO += 0.5 * lib.einsum(&#39;mfbe,ijfe-&gt;mbij&#39;, eris_ovvv, tau)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">woVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fvv</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fvv</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,meaf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,ijef-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfbe,ijfe-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">woVvO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mebf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">woVVo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mfbe-&gt;mbej&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,mfne-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">-=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">woVVo</span> <span class="o">+=</span> <span class="n">tmp</span>

        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
        <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nfme-&gt;njme&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,njme-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">ooov</span><span class="p">)</span>
        <span class="n">woVVo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mjne-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">ooov</span><span class="p">)</span>

        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
        <span class="n">tilab</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foo</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">t2</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">t2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njfb,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">ovov</span> <span class="o">=</span> <span class="n">tilab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Foo</span> <span class="o">+=</span> <span class="n">foo</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ie-&gt;mi&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="o">+</span><span class="n">fov</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvv</span> <span class="o">+=</span> <span class="n">fvv</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="o">+</span><span class="n">fov</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

        <span class="c1"># 0 or 1 virtuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mine-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nime,jneb-&gt;mbji&#39;</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">-=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">-=</span> <span class="n">tmp</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,njeb-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoV</span> <span class="o">=</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foo</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,mine-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">ooov</span><span class="p">)</span>
        <span class="n">ooov</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoV</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,mfne-&gt;mnie&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp1abba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,nemf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nifb,menf-&gt;mbei&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span> <span class="o">*</span> <span class="o">-.</span><span class="mi">5</span>
        <span class="n">tmp1ab</span><span class="o">+=</span> <span class="n">tmp1abba</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">tmpab</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mbej-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="p">)</span>
        <span class="n">tmpab</span><span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mbej-&gt;mbji&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp1abba</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">-=</span> <span class="n">tmpab</span>
        <span class="n">eris_oovo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">+=</span> <span class="n">eris_oovo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">eris_oovo</span> <span class="o">=</span> <span class="n">tmpab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">+=</span> <span class="n">eris_ovvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">woVVo</span> <span class="o">-=</span> <span class="n">eris_oovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;woVvO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">woVvO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;woVVo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">woVVo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVvO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;woVvO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVVo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;woVVo&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mebj-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mjbe-&gt;mbji&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_oovv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ijeb-&gt;mbij&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mnij-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span><span class="p">)</span>

        <span class="c1"># 3 or 4 virtuals</span>
        <span class="c1">#:eris_oovv = np.asarray(eris.oovv)</span>
        <span class="c1">#:eris_ovvo = np.asarray(eris.ovvo)</span>
        <span class="c1">#:self.wvOvV = einsum(&#39;nime,mnab-&gt;eiab&#39;, eris_ooov, tau)</span>
        <span class="c1">#:self.wvOvV -= lib.einsum(&#39;me,miab-&gt;eiab&#39;, self.Fov, t2)</span>
        <span class="c1">#:tmpab = lib.einsum(&#39;ma,mbei-&gt;eiab&#39;, t1, tmp1ab)</span>
        <span class="c1">#:tmpab+= lib.einsum(&#39;ma,mbei-&gt;eiba&#39;, t1, tmp1abba)</span>
        <span class="c1">#:tmpab-= einsum(&#39;ma,mibe-&gt;eiba&#39;, t1, eris_oovv)</span>
        <span class="c1">#:tmpab-= einsum(&#39;ma,mebi-&gt;eiab&#39;, t1, eris_ovvo)</span>
        <span class="c1">#:self.wvOvV += tmpab</span>

        <span class="c1">#:theta = t2*2 - t2.transpose(0,1,3,2)</span>
        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocc*nvir,nvir**2)).reshape(nocc,nvir,nvir,nvir)</span>
        <span class="c1">#:ovvv = eris_ovvv*2 - eris_ovvv.transpose(0,3,2,1)</span>
        <span class="c1">#:tmpab = lib.einsum(&#39;mebf,miaf-&gt;eiab&#39;, eris_ovvv, t2)</span>
        <span class="c1">#:tmpab = tmpab + tmpab.transpose(0,1,3,2) * .5</span>
        <span class="c1">#:tmpab-= lib.einsum(&#39;mfbe,mifa-&gt;eiba&#39;, ovvv, theta) * .5</span>
        <span class="c1">#:self.wvOvV += eris_ovvv.transpose(2,0,3,1).conj()</span>
        <span class="c1">#:self.wvOvV -= tmpab</span>
        <span class="n">tmp1ab</span> <span class="o">-=</span> <span class="n">eris_ovvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">tmp1abba</span> <span class="o">-=</span> <span class="n">eris_oovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">eris_oovv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">6</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">wvOvV</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nime,mnab-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">],</span> <span class="n">tau</span><span class="p">)</span>

            <span class="n">wvOvV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,miab-&gt;eiab&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">t2</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
            <span class="n">tmpab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbei-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="p">[:,:,:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
            <span class="n">tmpab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbei-&gt;eiba&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp1abba</span><span class="p">[:,:,:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
            <span class="n">wvOvV</span> <span class="o">+=</span> <span class="n">tmpab</span>

            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p0</span> <span class="o">==</span> <span class="n">i0</span><span class="p">:</span>
                    <span class="n">wvOvV</span> <span class="o">+=</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">tmpab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,miaf-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">tmpab</span> <span class="o">=</span> <span class="n">tmpab</span> <span class="o">+</span> <span class="n">tmpab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">ovvv</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmpab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfbe,mifa-&gt;eiba&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
                <span class="n">wvOvV</span> <span class="o">-=</span> <span class="n">tmpab</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wvOvV</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">tmpab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">made_ee_imds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD EE intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">+</span> <span class="n">tau</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tau</span> <span class="o">*=</span> <span class="n">fac</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">tau</span> <span class="o">+=</span> <span class="n">t2</span>
    <span class="k">return</span> <span class="n">tau</span>

<span class="k">def</span> <span class="nf">_unpack_4fold</span><span class="p">(</span><span class="n">c2vec</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">):</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c2vec</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nocc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nvir</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">t2tril</span> <span class="o">=</span> <span class="n">c2vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">otril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t2tril</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t2tril</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t2tril</span> <span class="o">=</span> <span class="o">-</span><span class="n">t2tril</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t2tril</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t2tril</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">t2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_add_vvvv_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Ht2</span><span class="p">):</span>
    <span class="n">nocc</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nvir</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t2tril</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
    <span class="n">t2tril</span> <span class="o">=</span> <span class="n">ccsd</span><span class="o">.</span><span class="n">add_wvvVV_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)),</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t2tril</span><span class="p">,</span>
                             <span class="n">with_ovvv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">idxo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="p">)</span>
    <span class="n">t2tril</span><span class="p">[</span><span class="n">idxo</span><span class="o">*</span><span class="p">(</span><span class="n">idxo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">idxo</span><span class="p">]</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">idxo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">Ht2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                   <span class="n">t2tril</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                   <span class="n">idxo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">idxo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Ht2</span>

<span class="k">def</span> <span class="nf">_add_vvvv1_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Ht2</span><span class="p">):</span>
    <span class="n">nvir</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
        <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">vvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">Ht2</span><span class="p">[:,:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,ebf-&gt;ijb&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">[:,:,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">vvv</span><span class="p">)</span>
        <span class="n">Ht2</span><span class="p">[:,:,:</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijf,abf-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">vvv</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
        <span class="n">vvv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">Ht2</span>

<span class="k">def</span> <span class="nf">_mem_usage</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">):</span>
    <span class="n">incore</span> <span class="o">=</span> <span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="n">nvir</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span>
    <span class="c1"># Roughly, factor of two for intermediates and factor of two</span>
    <span class="c1"># for safety (temp arrays, copying, etc)</span>
    <span class="n">incore</span> <span class="o">*=</span> <span class="mi">4</span>
    <span class="c1"># TODO: Improve incore estimate and add outcore estimate</span>
    <span class="n">outcore</span> <span class="o">=</span> <span class="n">basic</span> <span class="o">=</span> <span class="n">incore</span>
    <span class="k">return</span> <span class="n">incore</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span><span class="p">,</span> <span class="n">outcore</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span><span class="p">,</span> <span class="n">basic</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span>

<span class="k">def</span> <span class="nf">_cp</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">scf</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">gto</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">Mole</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">8</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="mf">0.</span>     <span class="p">,</span> <span class="mf">0.</span><span class="p">)],</span>
        <span class="p">[</span><span class="mi">1</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.757</span> <span class="p">,</span> <span class="mf">0.587</span><span class="p">)],</span>
        <span class="p">[</span><span class="mi">1</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="mf">0.757</span>  <span class="p">,</span> <span class="mf">0.587</span><span class="p">)]]</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="s1">&#39;cc-pvdz&#39;</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">spin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">scf</span><span class="p">())</span>

    <span class="n">mycc</span> <span class="o">=</span> <span class="n">RCCSD</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
    <span class="n">ecc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ecc</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.2133432712431435</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IP energies... (right eigenvector)&quot;</span><span class="p">)</span>
    <span class="n">part</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">e</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">ipccsd</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">partition</span><span class="o">=</span><span class="n">part</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.4335604332073799</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5187659896045407</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.6782876002229172</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IP energies... (left eigenvector)&quot;</span><span class="p">)</span>
    <span class="n">e</span><span class="p">,</span><span class="n">lv</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">ipccsd</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">partition</span><span class="o">=</span><span class="n">part</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.4335604332073799</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5187659896045407</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.6782876002229172</span><span class="p">)</span>

    <span class="n">mycc</span><span class="o">.</span><span class="n">ipccsd_star</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">lv</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EA energies... (right eigenvector)&quot;</span><span class="p">)</span>
    <span class="n">e</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">eaccsd</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">partition</span><span class="o">=</span><span class="n">part</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.16737886338859731</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.24027613852009164</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.51006797826488071</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EA energies... (left eigenvector)&quot;</span><span class="p">)</span>
    <span class="n">e</span><span class="p">,</span><span class="n">lv</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">eaccsd</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">partition</span><span class="o">=</span><span class="n">part</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.16737886338859731</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.24027613852009164</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.51006797826488071</span><span class="p">)</span>

    <span class="n">mycc</span><span class="o">.</span><span class="n">eaccsd_star</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">lv</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-, Qiming Sun &lt;osirpt.sun@gmail.com&gt;.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.4.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>